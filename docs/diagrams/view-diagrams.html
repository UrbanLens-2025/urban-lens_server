<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Lens - Class & Sequence Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 40px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 8px;
        }
        .mermaid {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section {
            background: white;
            padding: 30px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        nav {
            background: #4CAF50;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
        }
        nav a:hover {
            text-decoration: underline;
        }
        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <nav>
        <a href="#entities">Entities</a>
        <a href="#services">Services</a>
        <a href="#sequences">Sequence Diagrams</a>
    </nav>

    <h1>Urban Lens Server - Architecture Diagrams</h1>
    <div class="note">
        <strong>üìå Note:</strong> Diagrams n√†y m√¥ t·∫£ c·∫•u tr√∫c v√† flow c·ªßa User, Post, Itinerary, Mission, v√† Voucher features.
    </div>

    <div class="section" id="entities">
        <h2>1. Entities Class Diagram</h2>
        <div class="mermaid">
classDiagram
    %% User Domain
    class AccountEntity {
        +UUID id
        +String firstName
        +String lastName
        +String email
        +String phoneNumber
        +String password
        +String avatarUrl
        +String coverUrl
        +Boolean hasOnboarded
        +Role role
        +Date createdAt
        +Date updatedAt
        +canCreateEvent() Boolean
        +canPerformActions() Boolean
    }

    class UserProfileEntity {
        +UUID accountId
        +Date dob
        +UUID rankId
        +AccountEntity account
        +RankEntity rankEntity
    }

    class PostEntity {
        +UUID postId
        +String content
        +PostType type
        +Integer rating
        +String[] imageUrls
        +UUID authorId
        +UUID locationId
        +UUID eventId
        +Visibility visibility
        +Date createdAt
        +Date updatedAt
    }

    class ItineraryEntity {
        +UUID id
        +UUID userId
        +String title
        +String description
        +Date startDate
        +Date endDate
        +ItinerarySource source
        +String[] album
        +String thumbnailUrl
        +UUID[] locationWishlist
        +Date createdAt
        +Date updatedAt
    }

    class LocationMissionEntity {
        +UUID id
        +UUID locationId
        +String title
        +String description
        +Integer target
        +Date startDate
        +Date endDate
        +Integer reward
        +String[] imageUrls
    }

    class UserMissionProgressEntity {
        +UUID id
        +UUID userProfileId
        +UUID missionId
        +Integer progress
        +Boolean completed
    }

    class LocationVoucherEntity {
        +UUID id
        +UUID locationId
        +String title
        +String voucherCode
        +Integer pricePoint
        +Integer maxQuantity
        +LocationVoucherType voucherType
        +Date startDate
        +Date endDate
    }

    class UserLocationVoucherExchangeHistoryEntity {
        +UUID id
        +UUID voucherId
        +UUID userProfileId
        +Integer pointSpent
        +String userVoucherCode
        +Date usedAt
        +Date createdAt
    }

    class LocationEntity {
        +UUID id
        +UUID businessId
        +String name
        +Decimal latitude
        +Decimal longitude
        +LocationOwnershipType ownershipType
    }

    AccountEntity ||--o| UserProfileEntity : "has"
    AccountEntity ||--o{ PostEntity : "creates"
    AccountEntity ||--o{ ItineraryEntity : "creates"
    UserProfileEntity ||--o{ UserMissionProgressEntity : "tracks"
    LocationMissionEntity ||--o{ UserMissionProgressEntity : "tracked by"
    LocationVoucherEntity ||--o{ UserLocationVoucherExchangeHistoryEntity : "exchanged as"
    UserProfileEntity ||--o{ UserLocationVoucherExchangeHistoryEntity : "exchanges"
        </div>
    </div>

    <div class="section" id="services">
        <h2>2. Services Class Diagram</h2>
        <div class="mermaid">
classDiagram
    class IPostService {
        <<interface>>
        +createPost(dto) Promise
        +getPostById(id, userId) Promise
        +reactPost(dto) Promise
        +deletePost(dto) Promise
    }

    class PostService {
        -PostRepository postRepository
        -IFileStorageService fileStorageService
        +createPost(dto) Promise
        +getPostById(id, userId) Promise
    }

    class IItineraryService {
        <<interface>>
        +createItinerary(userId, dto) Promise
        +updateItinerary(id, userId, dto) Promise
        +getItineraryById(id, userId) Promise
    }

    class ItineraryService {
        -ItineraryRepository itineraryRepository
        -IFileStorageService fileStorageService
        +createItinerary(userId, dto) Promise
        +updateItinerary(id, userId, dto) Promise
    }

    class IQRCodeScanService {
        <<interface>>
        +scanQRCode(userId, dto) Promise
        +getUserMissions(userId, locationId) Promise
        +getMyMissionsInProgress(userId, locationId) Promise
    }

    class IVoucherExchangeService {
        <<interface>>
        +exchangeVoucher(userId, voucherId) Promise
        +getUserVouchers(userId) Promise
        +useVoucher(userId, voucherCode) Promise
    }

    IPostService <|.. PostService
    IItineraryService <|.. ItineraryService
        </div>
    </div>

    <div class="section" id="sequences">
        <h2>3. Sequence Diagrams</h2>

        <h3>3.1 Create Post Flow</h3>
        <div class="mermaid">
sequenceDiagram
    participant Client
    participant PostController
    participant PostService
    participant FileStorageService
    participant PostRepository
    participant EventEmitter

    Client->>PostController: POST /user/post
    PostController->>PostService: createPost(dto, userId)
    
    alt Image URLs provided
        PostService->>FileStorageService: confirmUpload(imageUrls)
        FileStorageService-->>PostService: success
    end
    
    PostService->>PostRepository: save(PostEntity)
    PostRepository-->>PostService: savedPost
    
    PostService->>EventEmitter: emit(POST_CREATED_EVENT)
    EventEmitter-->>PostService: emitted
    
    PostService-->>PostController: PostResponseDto
    PostController-->>Client: 201 Created
        </div>

        <h3>3.2 Create Itinerary Flow</h3>
        <div class="mermaid">
sequenceDiagram
    participant Client
    participant ItineraryController
    participant ItineraryService
    participant FileStorageService
    participant DataSource

    Client->>ItineraryController: POST /user/itinerary
    ItineraryController->>ItineraryService: createItinerary(userId, dto)
    
    ItineraryService->>DataSource: transaction()
    
    alt Thumbnail URL provided
        ItineraryService->>FileStorageService: confirmUpload([thumbnailUrl])
        FileStorageService-->>ItineraryService: success
    end
    
    ItineraryService->>DataSource: save(itinerary)
    DataSource-->>ItineraryService: savedItinerary
    
    ItineraryService->>DataSource: commit()
    ItineraryService-->>ItineraryController: ItineraryResponseDto
    ItineraryController-->>Client: 201 Created
        </div>

        <h3>3.3 Scan QR Code and Complete Mission Flow</h3>
        <div class="mermaid">
sequenceDiagram
    participant Client
    participant QRController
    participant QRService
    participant QRRepository
    participant MissionProgressRepository
    participant UserProfileRepository

    Client->>QRController: POST /user/qr-scan/scan
    QRController->>QRService: scanQRCode(userId, dto)
    
    QRService->>QRRepository: findByQrCodeData(qrCodeData)
    QRRepository-->>QRService: qrCode
    
    alt Mission exists
        QRService->>MissionProgressRepository: incrementProgress()
        MissionProgressRepository-->>QRService: updatedProgress
        
        alt Mission completed
            QRService->>UserProfileRepository: addPoints(userId, reward)
            UserProfileRepository-->>QRService: updated
        end
    end
    
    QRService->>QRRepository: updateIsUsed(qrCode.id)
    QRService-->>QRController: QRScanResultDto
    QRController-->>Client: 200 OK
        </div>

        <h3>3.4 Exchange Voucher Flow</h3>
        <div class="mermaid">
sequenceDiagram
    participant Client
    participant VoucherController
    participant VoucherExchangeService
    participant VoucherRepository
    participant UserProfileRepository
    participant VoucherHistoryRepository

    Client->>VoucherController: POST /user/voucher/exchange
    VoucherController->>VoucherExchangeService: exchangeVoucher(userId, voucherId)
    
    VoucherExchangeService->>VoucherRepository: findOne(voucherId)
    VoucherRepository-->>VoucherExchangeService: voucher
    
    VoucherExchangeService->>UserProfileRepository: deductPoints(userId, pricePoint)
    UserProfileRepository-->>VoucherExchangeService: updated
    
    VoucherExchangeService->>VoucherRepository: decrementQuantity(voucherId)
    VoucherExchangeService->>VoucherHistoryRepository: create(voucherHistory)
    
    VoucherExchangeService-->>VoucherController: UserVoucherResponseDto
    VoucherController-->>Client: 200 OK
        </div>

        <h3>3.5 Get User Missions Flow</h3>
        <div class="mermaid">
sequenceDiagram
    participant Client
    participant MissionController
    participant QRService
    participant MissionProgressRepository

    Client->>MissionController: GET /user/location-mission/my-missions
    MissionController->>QRService: getUserMissions(userId, locationId)
    
    QRService->>MissionProgressRepository: createQueryBuilder()
    QRService->>MissionProgressRepository: where(userProfileId = userId)
    
    alt locationId provided
        QRService->>MissionProgressRepository: andWhere(locationId = locationId)
    end
    
    QRService->>MissionProgressRepository: getMany()
    MissionProgressRepository-->>QRService: missions[]
    
    QRService-->>MissionController: MissionProgressDto[]
    MissionController-->>Client: 200 OK
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#4CAF50',
                primaryTextColor: '#fff',
                primaryBorderColor: '#2E7D32',
                lineColor: '#333',
                secondaryColor: '#C8E6C9',
                tertiaryColor: '#f5f5f5'
            }
        });
    </script>
</body>
</html>
